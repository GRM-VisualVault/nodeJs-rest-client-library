require("./serviceCore");var HTTP=require("http"),jwt=require("./jwtSupport"),requestSigning=require("./requestSigning"),jsyaml=require("js-yaml"),nodeJsRequest=require("request"),Q=require("q"),authorize=function(){function n(){}return n.prototype.getVaultApi=function(n,t,i,r,u,f){var e=require("./config.yml"),o,s;return this.endsWith(r,"/")&&(r=r.substring(0,r.length-1)),o=e.ApiUri.replace("{custalias}",u).replace("{custdbalias}",f),s=e.AutheticateUri.replace("{custalias}",u).replace("{custdbalias}",f),this.acquireSecurityToken(n,t,i,r,o,u,f,s)},n.prototype.acquireSecurityToken=function(n,t,i,r,u,f,e,o){var h=this,s=Q.defer();return Q.when(this.__getToken(n,t,i,r,f,e,o,!0)).then(function(h){var c,l;console.log("acquireSecurityToken Success"),l=null,typeof h!="undefined"&&h!=null&&(c=require("./vault/common/sessionToken"),c.baseUrl=r,c.apiUrl=u,c.loginToken=n,c.authenticationUrl=o,c.customerAlias=f,c.databaseAlias=e,c.developerId=t,c.developerSecret=i,c.isAuthenticated=!0,c.tokenType=0,c.expirationDateUtc=h.expirationDateUtc,c.tokenBase64=h.tokenBase64,l=require("./VVRestApi"),l.init(c)),s.resolve(l)}).fail(function(n){console.log("acquireSecurityToken Failed"),s.reject(new Error(n))}),s.promise},n.prototype.endsWith=function(n,t){return n.indexOf(t,n.length-t.length)!==-1},n.prototype.__getToken=function(n,t,i,r,u,f,e,o){var it=this,v,h,p,w;console.log("Getting token");var s=Q.defer(),b=new Buffer(i,"base64"),k=new Date,d=parseInt((k.getTime()/1e3).toString()),c=new Date;c.setMinutes(c.getMinutes()+30),v=parseInt((c.getTime()/1e3).toString()),h=new Date,h.setMinutes(h.getMinutes()-5);var g=parseInt((h.getTime()/1e3).toString()),nt={iss:"self:user",devid:t,prn:n,aud:"http://VisualVault/api",exp:v,nbf:g,iat:d},y=jwt.encode(nt,b,"HS256"),tt=function(n,t,i){var r=require("./vault/common/sessionToken"),u;return n?(r.isAuthenticated=!1,console.log("Error from acquiring token: "+n),s.reject(new Error(n))):(o&&(console.log("Returned Status: "+t.statusCode),console.log("Returned Body: "+t.body)),t.statusCode==200?(u=JSON.parse(i),r.tokenBase64=u.data.token,r.expirationDateUtc=new Date(u.data.expires),r.isAuthenticated=!0,s.resolve(r)):t.statusCode==401||t.statusCode==403?(r.isAuthenticated=!1,console.log("Authorization has been refused for current credentials"),s.reject(new Error("Authorization has been refused for current credentials"))):(r.isAuthenticated=!1,console.log("Unknown response for access token"),s.reject(new Error("Unknown response for access token")))),r},l=r+e,a={};return a.Authorization="Bearer "+y,p=require("./requestSigning.js"),p.sign(a,l,"GET",null,t,i,"SHA256"),w={method:"GET",uri:l,headers:a},console.log("\n\nSending request for access token to "+l+"\n\n"),console.log("token: "+y),nodeJsRequest(w,function(n,t,i){tt(n,t,i)}),s.promise},n}();module.exports=new authorize