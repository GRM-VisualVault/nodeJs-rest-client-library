require("./serviceCore");var HTTP=require("http"),jwt=require("./jwtSupport"),requestSigning=require("./requestSigning"),jsyaml=require("js-yaml"),nodeJsRequest=require("request"),Q=require("q"),VVRestApi=function(){function n(n,t,i,r,u,f,e){if(this._config=require("./config.yml"),this._isAuthenticated=!1,this._token=null,this._isDebugMode=!1,this._developerSecret="",this._developerId="",this._apiKey="",this._custAlias="",this._custDbAlias="",this._baseUrl="",this._apiUrl="",this._authenticationUrl="",this.endsWith(f,"/")&&(f=f.substring(0,f.length-1)),typeof n=="string")this._custAlias=n,this._custDbAlias=t,this._developerSecret=u,this._developerId=r,this._apiKey=i,this._baseUrl=f;else if(typeof n=="object"){var o=n;this._custAlias=o.CustomerAlias,this._custDbAlias=o.DatabaseAlias,this._developerSecret=o.DeveloperSecret,this._developerId=o.DeveloperId,this._apiKey=o.ApiKey,this._baseUrl=o.baseUrl}this._apiUrl=this._config.ApiUri.replace("{custalias}",this._custAlias).replace("{custdbalias}",this._custDbAlias),this._authenticationUrl=this._config.AutheticateUri.replace("{custalias}",this._custAlias).replace("{custdbalias}",this._custDbAlias),(this._developerSecret===null||this._developerSecret==="")&&(this._developerSecret=this._config.DeveloperSecret),(this._developerId===null||this._developerId==="")&&(this._developerId=this._config.DeveloperId),(this._apiKey===null||this._apiKey==="")&&(this._apiKey=this._config.ApiKey),this._isDebugMode=e,this._isDebugMode&&(console.log("Authentication Url: "+this._authenticationUrl),console.log("Base Url: "+this._baseUrl))}return n.prototype.endsWith=function(n,t){return n.indexOf(t,n.length-t.length)!==-1},n.prototype.acquireSecurityToken=function(){var t=this,n=Q.defer();return Q.when(this.__getToken()).then(function(t){console.log("acquireSecurityToken Success"),n.resolve(t)}).fail(function(t){console.log("acquireSecurityToken Failed"),n.reject(new Error(t))}),n.promise},n.prototype.getFormTemplates=function(n){var t=this.__getUrl(this._config.ResourceUri.FormTemplates);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.getForms=function(n,t){var i=this._config.ResourceUri.Forms.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postForms=function(n,t,i){var r=this._config.ResourceUri.Forms.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.postFormRevision=function(n,t,i,r){var u=this._config.ResourceUri.Forms.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"POST"},n,t)},n.prototype.getSites=function(n){var t=this.__getUrl(this._config.ResourceUri.Sites);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.postSites=function(n,t){var i=this._config.ResourceUri.Sites,r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"POST"},n,t)},n.prototype.putSites=function(n,t,i){var r=this._config.ResourceUri.Sites,u=this.__getUrl(r+"/"+i);return this.__doVvClientRequest(u,{method:"PUT"},n,t)},n.prototype.getUsers=function(n,t){var i=this._config.ResourceUri.Users.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postUsers=function(n,t,i){var r=this._config.ResourceUri.Users.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.putUsers=function(n,t,i,r){var u=this._config.ResourceUri.Users.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"PUT"},n,t)},n.prototype.getGroups=function(n,t){var i=this._config.ResourceUri.Groups.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postGroups=function(n,t,i){var r=this._config.ResourceUri.Groups.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.putGroups=function(n,t,i,r){var u=this._config.ResourceUri.Groups.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"PUT"},n,t)},n.prototype.getFolders=function(n){var t=this.__getUrl(this._config.ResourceUri.Folders);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.getDocuments=function(n,t){var i=this._config.ResourceUri.Documents.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postEmails=function(n,t){var i=this.__getUrl(this._config.ResourceUri.Emails);return this.__doVvClientRequest(i,{method:"POST"},n,t)},n.prototype.getSecurityToken=function(){return this._token},n.prototype.isAuthenticated=function(){return this._isAuthenticated},n.prototype.getBaseUrl=function(){return this._baseUrl},n.prototype.request=function(n,t,i,r){var u={method:""};return u.method=n.toLowerCase()==="post"?"POST":n.toLowerCase()==="put"?"PUT":n.toLowerCase()==="delete"?"DELETE":"GET",this.__doVvClientRequest(t,u,i,r)},n.prototype.httpGet=function(n,t,i){var u=this,r={method:"GET",uri:n,qs:t};this._token==null?this.__acquireNewTokenWithRequest(r,i):(t.token=this._token,console.log("Performing GET request to url:"+n),nodeJsRequest(r,function(n,t,r){i(n,t,r)}))},n.prototype.httpPost=function(n,t,i,r){var f=this,u={method:"POST",uri:n,qs:t,json:i};this._token==null?this.__acquireNewTokenWithRequest(u,r):(t.token=this._token,console.log("Performing POST request to url:"+n),nodeJsRequest(u,function(n,t,i){r(n,t,i)}))},n.prototype.httpPut=function(n,t,i,r){var f=this,u={method:"PUT",uri:n,qs:t,json:i};this._token==null?this.__acquireNewTokenWithRequest(u,r):(t.token=this._token,console.log("Performing PUT request to url:"+n),nodeJsRequest(u,function(n,t,i){r(n,t,i)}))},n.prototype.httpDelete=function(n,t,i){var u=this,r={method:"DELETE",uri:n,qs:t};this._token==null?this.__acquireNewTokenWithRequest(r,i):(t.token=this._token,console.log("Performing DELETE request to url:"+n),nodeJsRequest(r,function(n,t,r){i(n,t,r)}))},n.prototype.__acquireNewTokenWithRequest=function(n,t){var i=0;Q.when(this.__getToken()).then(function(){n.qs.token=this._token,nodeJsRequest(n,function(n,i,r){t(n,i,r)})}).fail(function(){i++,this.__recursiveAttemptAcquireToken(n,t,i)})},n.prototype.__recursiveAttemptAcquireToken=function(n,t,i){Q.when(this.__getToken()).then(function(){n.qs.token=this._token,nodeJsRequest(n,function(n,i,r){t(n,i,r)})}).fail(function(){i<6&&(i++,this.__recursiveAttemptAcquireToken(n,t,i))})},n.prototype.__doVvClientRequest=function(n,t,i,r){var e=this,u=Q.defer(),f=function(n,t,i){if(n)console.log("In vvClientRequestCallback with error condition"),u.reject(new Error(n));else if(t.statusCode===403){e._token=null,e._isAuthenticated=!1;var r=JSON.parse(i);u.reject(new Error(r.meta))}else console.log("In vvClientRequestCallback with success: "+i),u.resolve(i)};if(t.method==="GET")this.httpGet(n,i,f);else if(t.method==="POST")this.httpPost(n,i,r,f);else if(t.method==="PUT")this.httpPut(n,i,r,f);else if(t.method==="DELETE")this.httpDelete(n,i,f);else throw new Error("http request method name error");return u.promise},n.prototype.__getUrl=function(n){return this._baseUrl+this._apiUrl+n},n.prototype.__getToken=function(){var n=this,e,i,o,s;console.log("Getting token");var t=Q.defer(),h=new Buffer(this._developerSecret,"base64"),c=new Date,l=parseInt((c.getTime()/1e3).toString()),r=new Date;r.setMinutes(r.getMinutes()+30),e=parseInt((r.getTime()/1e3).toString()),i=new Date,i.setMinutes(i.getMinutes()-5);var a=parseInt((i.getTime()/1e3).toString()),v={iss:"self:user",devid:this._developerId,prn:this._apiKey,aud:"http://VisualVault/api",exp:e,nbf:a,iat:l},y=jwt.encode(v,h,"HS256"),p=function(i,r,u){if(i)n._isAuthenticated=!1,console.log("Error from acquiring token: "+i),t.reject(new Error(i));else if(n._isDebugMode&&(console.log("Returned Status: "+r.statusCode),console.log("Returned Body: "+r.body)),r.statusCode==200){var f=JSON.parse(u);n._token=f.data.token,n._isAuthenticated=!0,t.resolve(null)}else r.statusCode==401||r.statusCode==403?(n._isAuthenticated=!1,console.log("Authorization has been refused for current credentials"),t.reject(new Error("Authorization has been refused for current credentials"))):(n._isAuthenticated=!1,console.log("Unknown response for access token"),t.reject(new Error("Unknown response for access token")))},u=this._baseUrl+this._authenticationUrl,f={};return f.Authorization="Bearer "+y,o=require("./requestSigning.js"),o.sign(f,u,"GET",null,this._developerId,this._developerSecret,"SHA256"),s={method:"GET",uri:u,headers:f},console.log("\n\nSending request for access token to "+u+"\n\n"),nodeJsRequest(s,function(n,t,i){p(n,t,i)}),t.promise},n}();module.exports=VVRestApi