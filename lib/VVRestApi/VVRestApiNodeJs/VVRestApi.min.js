require("./serviceCore");var HTTP=require("http"),jwt=require("./jwtSupport"),requestSigning=require("./requestSigning"),jsyaml=require("js-yaml"),nodeJsRequest=require("request"),Q=require("q"),VVRestApi=function(){function n(){this._config=null,this._sessionToken=null}return n.prototype.init=function(n){this._config=require("./config.yml"),this._sessionToken=n},n.prototype.endsWith=function(n,t){return n.indexOf(t,n.length-t.length)!==-1},n.prototype.acquireSecurityToken=function(){var t=this,n=Q.defer();return Q.when(this.__getToken()).then(function(t){console.log("acquireSecurityToken Success"),n.resolve(t)}).fail(function(t){console.log("acquireSecurityToken Failed"),n.reject(new Error(t))}),n.promise},n.prototype.getFormTemplates=function(n){var t=this.__getUrl(this._config.ResourceUri.FormTemplates);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.getForms=function(n,t){var i=this._config.ResourceUri.Forms.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postForms=function(n,t,i){var r=this._config.ResourceUri.Forms.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.postFormRevision=function(n,t,i,r){var u=this._config.ResourceUri.Forms.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"POST"},n,t)},n.prototype.getSites=function(n){var t=this.__getUrl(this._config.ResourceUri.Sites);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.postSites=function(n,t){var i=this._config.ResourceUri.Sites,r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"POST"},n,t)},n.prototype.putSites=function(n,t,i){var r=this._config.ResourceUri.Sites,u=this.__getUrl(r+"/"+i);return this.__doVvClientRequest(u,{method:"PUT"},n,t)},n.prototype.getUsers=function(n,t){var i=this._config.ResourceUri.Users.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postUsers=function(n,t,i){var r=this._config.ResourceUri.Users.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.putUsers=function(n,t,i,r){var u=this._config.ResourceUri.Users.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"PUT"},n,t)},n.prototype.getGroups=function(n,t){var i=this._config.ResourceUri.Groups.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postGroups=function(n,t,i){var r=this._config.ResourceUri.Groups.replace("{id}",i),u=this.__getUrl(r);return this.__doVvClientRequest(u,{method:"POST"},n,t)},n.prototype.putGroups=function(n,t,i,r){var u=this._config.ResourceUri.Groups.replace("{id}",i),f=this.__getUrl(u+"/"+r);return this.__doVvClientRequest(f,{method:"PUT"},n,t)},n.prototype.getFolders=function(n){var t=this.__getUrl(this._config.ResourceUri.Folders);return this.__doVvClientRequest(t,{method:"GET"},n,null)},n.prototype.getDocuments=function(n,t){var i=this._config.ResourceUri.Documents.replace("{id}",t),r=this.__getUrl(i);return this.__doVvClientRequest(r,{method:"GET"},n,null)},n.prototype.postEmails=function(n,t){var i=this.__getUrl(this._config.ResourceUri.Emails);return this.__doVvClientRequest(i,{method:"POST"},n,t)},n.prototype.getSecurityToken=function(){return this._sessionToken.tokenBase64},n.prototype.isAuthenticated=function(){return this._sessionToken.isAuthenticated},n.prototype.getBaseUrl=function(){return this._sessionToken.baseUrl},n.prototype.request=function(n,t,i,r){var u={method:""};return u.method=n.toLowerCase()==="post"?"POST":n.toLowerCase()==="put"?"PUT":n.toLowerCase()==="delete"?"DELETE":"GET",this.__doVvClientRequest(t,u,i,r)},n.prototype.httpGet=function(n,t,i){var u=this,r={method:"GET",uri:n,qs:t};this._sessionToken.tokenBase64==null?this.__acquireNewTokenWithRequest(r,i):(t.token=this._sessionToken.tokenBase64,console.log("Performing GET request to url:"+n),nodeJsRequest(r,function(n,t,r){i(n,t,r)}))},n.prototype.httpPost=function(n,t,i,r){var f=this,u={method:"POST",uri:n,qs:t,json:i};this._sessionToken.tokenBase64==null?this.__acquireNewTokenWithRequest(u,r):(t.token=this._sessionToken.tokenBase64,console.log("Performing POST request to url:"+n),nodeJsRequest(u,function(n,t,i){r(n,t,i)}))},n.prototype.httpPut=function(n,t,i,r){var f=this,u={method:"PUT",uri:n,qs:t,json:i};this._sessionToken.tokenBase64==null?this.__acquireNewTokenWithRequest(u,r):(t.token=this._sessionToken.tokenBase64,console.log("Performing PUT request to url:"+n),nodeJsRequest(u,function(n,t,i){r(n,t,i)}))},n.prototype.httpDelete=function(n,t,i){var u=this,r={method:"DELETE",uri:n,qs:t};this._sessionToken.tokenBase64==null?this.__acquireNewTokenWithRequest(r,i):(t.token=this._sessionToken.tokenBase64,console.log("Performing DELETE request to url:"+n),nodeJsRequest(r,function(n,t,r){i(n,t,r)}))},n.prototype.__acquireNewTokenWithRequest=function(n,t){var i=0;Q.when(this.__getToken()).then(function(){n.qs.token=this._token,nodeJsRequest(n,function(n,i,r){t(n,i,r)})}).fail(function(){i++,this.__recursiveAttemptAcquireToken(n,t,i)})},n.prototype.__recursiveAttemptAcquireToken=function(n,t,i){Q.when(this.__getToken()).then(function(){n.qs.token=this._token,nodeJsRequest(n,function(n,i,r){t(n,i,r)})}).fail(function(){i<6&&(i++,this.__recursiveAttemptAcquireToken(n,t,i))})},n.prototype.__doVvClientRequest=function(n,t,i,r){var e=this,u=Q.defer(),f=function(n,t,i){if(n)console.log("In vvClientRequestCallback with error condition"),u.reject(new Error(n));else if(t.statusCode===403){e._sessionToken.tokenBase64=null,e._sessionToken.isAuthenticated=!1;var r=JSON.parse(i);u.reject(new Error(r.meta))}else console.log("In vvClientRequestCallback with success: "+i),u.resolve(i)};if(t.method==="GET")this.httpGet(n,i,f);else if(t.method==="POST")this.httpPost(n,i,r,f);else if(t.method==="PUT")this.httpPut(n,i,r,f);else if(t.method==="DELETE")this.httpDelete(n,i,f);else throw new Error("http request method name error");return u.promise},n.prototype.__getUrl=function(n){return this._sessionToken.baseUrl+this._sessionToken.apiUrl+n},n.prototype.__getToken=function(){var n=this,e,i,s,h;console.log("Getting token");var t=Q.defer(),c=new Buffer(this._sessionToken.developerSecret,"base64"),l=new Date,a=parseInt((l.getTime()/1e3).toString()),r=new Date;r.setMinutes(r.getMinutes()+30),e=parseInt((r.getTime()/1e3).toString()),i=new Date,i.setMinutes(i.getMinutes()-5);var v=parseInt((i.getTime()/1e3).toString()),y={iss:"self:user",devid:this._sessionToken.developerId,prn:this._sessionToken.loginToken,aud:"http://VisualVault/api",exp:e,nbf:v,iat:a},o=jwt.encode(y,c,"HS256"),p=function(i,r,u){if(i)n._sessionToken.isAuthenticated=!1,console.log("Error from acquiring token: "+i),t.reject(new Error(i));else if(r.statusCode==200){var f=JSON.parse(u);n._sessionToken.expirationDateUtc=new Date(f.data.expires),n._sessionToken.tokenBase64=f.data.expires,n._sessionToken.isAuthenticated=!0,t.resolve(null)}else r.statusCode==401||r.statusCode==403?(n._sessionToken.isAuthenticated=!1,console.log("Authorization has been refused for current credentials"),t.reject(new Error("Authorization has been refused for current credentials"))):(n._sessionToken.isAuthenticated=!1,console.log("Unknown response for access token"),t.reject(new Error("Unknown response for access token")))},u=this._sessionToken.baseUrl+this._sessionToken.authenticationUrl,f={};return f.Authorization="Bearer "+o,s=require("./requestSigning.js"),s.sign(f,u,"GET",null,this._sessionToken.developerId,this._sessionToken.developerSecret,"SHA256"),h={method:"GET",uri:u,headers:f},console.log("\n\nSending request for access token to "+u+"\n\n"),console.log("token: "+o),nodeJsRequest(h,function(n,t,i){p(n,t,i)}),t.promise},n}();module.exports=new VVRestApi