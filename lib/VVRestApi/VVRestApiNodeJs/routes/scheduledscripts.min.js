var clientLibrary=require("../vvRestApi"),scriptSecondAttempt;exports.processRequest=function(n,t){var e,f,r;console.log("Call from VisualVault to scripts");var o=require("fs"),s=require("q"),i={code:200,error:""},u=0;typeof n.body.script=="undefined"&&(console.log("Error, undefined form value named script"),i.code=201,i.error="script not found",t.json(201,i)),e=n.body.script,typeof n.body.baseUrl=="undefined"&&(console.log("Error, undefined form value named baseUrl"),i.code=201,i.error="baseUrl not found",t.json(201,i)),f=n.body.baseUrl,typeof n.query.id=="string"?(r=n.query.id,console.log("attempting to write script to ./files/"+r+".js"),o.writeFile("./files/"+r+".js",e,function(e){var h,c,o,l;if(e)console.log("Error, unable to write script file: "+e),i.code=201,i.error="File System error, unable to write script file.",t.json(201,i);else{console.log("loading user script file");try{for(h in require.cache)h.indexOf(r)>-1&&(console.log("deleting cached user script file: "+h),delete require.cache[h])}catch(a){console.log(a)}c=require("../files/"+r),o=c.getCredentials(),o.baseUrl=f,l=new clientLibrary.authorize,s.when(l.getVaultApi(o.loginToken,o.developerId,o.developerSecret,o.baseUrl,o.customerAlias,o.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;c.main(i,t)}).fail(function(i){console.log("Supervisor: Error response from acquireSecurityToken: "+i.message+" \r\n attempts: "+u),u++,scriptSecondAttempt(n,t,f,c,u)})}})):(i.code=201,i.error="Script file Id not specified",t.json(201,i))},scriptSecondAttempt=function(n,t,i,r,u){var f;console.log("Starting another attempt at securing security token, attempt number: "+u),f=r.getCredentials(),f.baseUrl=i;var o=new clientLibrary.authorize,s=require("q"),e={code:200,error:""};s.when(o.getVaultApi(f.loginToken,f.developerId,f.developerSecret,f.baseUrl,f.customerAlias,f.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;r.main(i,t)}).fail(function(f){console.log("Supervisor: Error response from acquireSecurityToken: "+f.message),u<6?(u++,scriptSecondAttempt(n,t,i,r,u)):(e.code=201,e.error="Unable to acquire security token",t.json(201,e))})}