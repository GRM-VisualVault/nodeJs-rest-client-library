exports.processRequest=function(n,t){var e,u,f;console.log("Call from VisualVault to scripts");var o=require("fs"),s=require("q"),i={code:200,error:""},r=0;typeof n.body.script=="undefined"&&(console.log("Error, undefined form value named script"),i.code=201,i.error="script not found",t.json(201,i)),e=n.body.script,typeof n.body.baseUrl=="undefined"&&(console.log("Error, undefined form value named baseUrl"),i.code=201,i.error="baseUrl not found",t.json(201,i)),u=n.body.baseUrl,typeof n.query.id=="string"?(f=n.query.id,console.log("attempting to write script to ./files/"+f+".js"),o.writeFile("./files/"+f+".js",e,function(f){var o,e,h,c;f?(console.log("Error, unable to write script file: "+f),i.code=201,i.error="File System error, unable to write script file.",t.json(201,i)):(console.log("loading user script file"),o=require("../userscheduledscript"),e=o.getCredentials(),e.baseUrl=u,h=require("./vvRestApi"),c=new h.authorize,s.when(c.getVaultApi(e.loginToken,e.developerId,e.developerSecret,e.baseUrl,e.customerAlias,e.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;o.main(i,t)}).fail(function(i){console.log("Supervisor: Error response from acquireSecurityToken: "+i.message+" \r\n attempts: "+r),r++,scriptSecondAttempt(n,t,u,o,r)}))})):(i.code=201,i.error="Script file Id not specified",t.json(201,i))};var scriptSecondAttempt=function(n,t,i,r,u){var f;console.log("Starting another attempt at securing security token, attempt number: "+u),f=r.getCredentials(),f.baseUrl=i;var s=require("../vaultApi"),o=new s(f),h=require("q"),e={code:200,error:""};h.when(o.acquireSecurityToken()).then(function(){console.log("Calling the user's Main method"),r.main(o,t)}).fail(function(f){console.log("Supervisor: Error response from acquireSecurityToken: "+f.message),u<6?(u++,scriptSecondAttempt(n,t,i,r,u)):(e.code=201,e.error="Unable to acquire security token",t.json(201,e))})}