var clientLibrary=require("../vvRestApi"),scriptSecondAttempt;exports.testsite=function(n,t){t.end("VisualVault Node Server [iisnode version is "+process.env.IISNODE_VERSION+", node version is "+process.version+"]")},exports.scripts=function(n,t){var o,u,f,r;console.log("Call from VisualVault to scripts");var s=require("fs"),h=require("q"),i={code:400,error:""},e=0;typeof n.body.script=="undefined"&&(console.log("Error, undefined form value named script"),i.code=201,i.error="script not found",t.json(201,i)),o=n.body.script,typeof n.body.baseUrl=="undefined"&&(console.log("Error, undefined form value named baseUrl"),i.code=201,i.error="baseUrl not found",t.json(201,i)),u=n.body.baseUrl,f=new clientLibrary.forms.formFieldCollection(JSON.parse(n.body.fields)),typeof n.query.id=="string"?(r=n.query.id,console.log("attempting to write script to ./files/"+r+".js"),s.writeFile("./files/"+r+".js",o,function(o){var c,l,s,a;if(o)console.log("Error, unable to write script file: "+o),i.code=201,i.error="File System error, unable to write script file.",t.json(201,i);else{console.log("loading user script file");try{for(c in require.cache)c.indexOf(r)>-1&&(console.log("deleting cached user script file: "+c),delete require.cache[c])}catch(v){console.log(v)}l=require("../files/"+r),s=l.getCredentials(),s.baseUrl=u,a=new clientLibrary.authorize,h.when(a.getVaultApi(s.loginToken,s.developerId,s.developerSecret,s.baseUrl,s.customerAlias,s.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;l.main(f,i,t)}).fail(function(i){console.log("Supervisor: Error response from acquireSecurityToken: "+i.message),e++,scriptSecondAttempt(n,t,u,f,l,e)})}})):(i.code=201,i.error="Script file Id not specified",t.json(201,i))},scriptSecondAttempt=function(n,t,i,r,u,f){var e;console.log("Starting another attempt at securing security token, attempt number: "+f),e=u.getCredentials(),e.baseUrl=i;var s=require("q"),o={code:200,error:""},h=new clientLibrary.authorize;s.when(h.getVaultApi(e.loginToken,e.developerId,e.developerSecret,e.baseUrl,e.customerAlias,e.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;u.main(r,i,t)}).fail(function(e){console.log("Supervisor: Error response from acquireSecurityToken: "+e.message),f<6?(f++,scriptSecondAttempt(n,t,i,r,u,f)):(o.code=201,o.error="Unable to acquire security token",t.json(201,o))})}