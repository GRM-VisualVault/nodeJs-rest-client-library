exports.testsite=function(n,t){t.end("VisualVault Node Server [iisnode version is "+process.env.IISNODE_VERSION+", node version is "+process.version+"]")},exports.scripts=function(n,t){var f,r;console.log("Call from VisualVault to scripts");var h=require("fs"),c=require("q"),i={code:400,error:""},u=0;typeof n.body.script=="undefined"&&(console.log("Error, undefined form value named script"),i.code=201,i.error="script not found",t.json(201,i)),f=n.body.script,typeof n.body.baseUrl=="undefined"&&(console.log("Error, undefined form value named baseUrl"),i.code=201,i.error="baseUrl not found",t.json(201,i));var e=require("./vvRestApi"),o=n.body.baseUrl,s=new e.forms.formFieldCollection(JSON.parse(n.body.fields));typeof n.query.id=="string"?(r=n.query.id,console.log("attempting to write script to ./files/"+r+".js"),h.writeFile("./files/"+r+".js",f,function(f){var l,h,a;f?(console.log("Error, unable to write script file: "+f),i.code=201,i.error="File System error, unable to write script file.",t.json(201,i)):(console.log("loading user script file"),l=require("../files/"+r),h=l.getCredentials(),h.baseUrl=o,a=new e.authorize,c.when(a.getVaultApi(h.loginToken,h.developerId,h.developerSecret,h.baseUrl,h.customerAlias,h.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;l.main(s,i,t)}).fail(function(i){console.log("Supervisor: Error response from acquireSecurityToken: "+i.message),u++,scriptSecondAttempt(n,t,o,s,l,u)}))})):(i.code=201,i.error="Script file Id not specified",t.json(201,i))};var scriptSecondAttempt=function(n,t,i,r,u,f){var e;console.log("Starting another attempt at securing security token, attempt number: "+f),e=u.getCredentials(),e.baseUrl=i;var s=require("q"),o={code:200,error:""},h=require("./vvRestApi"),c=new h.authorize;s.when(c.getVaultApi(e.loginToken,e.developerId,e.developerSecret,e.baseUrl,e.customerAlias,e.databaseAlias)).then(function(n){console.log("Calling the user's Main method");var i=n;u.main(r,i,t)}).fail(function(e){console.log("Supervisor: Error response from acquireSecurityToken: "+e.message),f<6?(f++,scriptSecondAttempt(n,t,i,r,u,f)):(o.code=201,o.error="Unable to acquire security token",t.json(201,o))})}